name: Validate Version

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions: 
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for tag comparison

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Validate version
      run: |
        # Extract version from setup.py
        SETUP_VERSION=$(python setup.py --version)
        echo "Setup.py version: $SETUP_VERSION"
        
        # For push/PR: warning only (don't fail)
        echo "Running on push/PR - performing format check only"
        
        # Check if version follows semantic versioning
        if ! echo "$SETUP_VERSION" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' > /dev/null; then
          echo "⚠️  WARNING: Version '$SETUP_VERSION' does not follow semantic versioning (X.Y.Z)"
        else
          echo "✓ Version format check passed!"
        fi
        
        # Check if version matches latest tag
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "no-tags")
        LATEST_TAG=${LATEST_TAG#v}
        
        if [ "$LATEST_TAG" != "no-tags" ]; then
          echo "Latest git tag: $LATEST_TAG"
          if [ "$SETUP_VERSION" == "$LATEST_TAG" ]; then
            echo "⚠️  WARNING: setup.py version matches latest tag - remember to bump version for next release!"
          fi
        fi
